<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Kasir Santri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 0;
    }

    .judul-box {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 16px;
      text-align: center;
      color: #333;
      margin-bottom: 4px;
    }

.form-group input:focus {
  outline: none;
  background-color: #e3f2fd;         /* ‚¨ÖÔ∏è biru pudar */
  color: #0d6efd;                    /* ‚¨ÖÔ∏è biru terang */
  font-weight: bold;                /* ‚¨ÖÔ∏è teks tebal */
  border: 2px solid #0d6efd;        /* ‚¨ÖÔ∏è garis biru terang */
  box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3); /* ‚¨ÖÔ∏è glow biru */
  transition: all 0.2s ease;
}

textarea:focus,
select:focus {
  background-color: #e3f2fd;
  color: #0d6efd;
  font-weight: bold;
  border: 2px solid #0d6efd;
  box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3);
  transition: all 0.2s ease;
}

.judul-container {
  position: fixed; /* ‚¨ÖÔ∏è Tetap di posisi atas layar */
  top: 0;           /* ‚¨ÖÔ∏è Menempel di bagian atas */
  left: 0;
  right: 0;
  z-index: 999;     /* ‚¨ÖÔ∏è Pastikan tampil di atas elemen lain */
  
  background: linear-gradient(to right, #2e7d32, #a5d6a7);
  padding: 4px 0;   /* ‚¨ÖÔ∏è Padding atas saja */
  margin: 0 auto;
  width: 100%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  color: white;
  text-align: center;
  border-radius: 0;
}

.judul-flex {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px; /* ‚¨ÖÔ∏è jarak antara logo dan teks */
}

.logo-kepang {
  width: 48px;
  height: 48px;
  object-fit: contain;
  margin-right: -4px;
  align-self: flex-end; /* ‚¨ÖÔ∏è sejajarkan ke bawah baris */
}

    .btn-mulai {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-bottom: 24px;
      margin-top: 120px;
    }
    .btn-mulai:hover {
      background-color: #218838;
    }

    .overlay-transaksi {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backdrop-filter: blur(6px);
      background-color: rgba(0, 0, 0, 0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

.subjudul-wrapper {
  text-align: center; /* ‚¨ÖÔ∏è pastikan kontennya rata tengah */
  margin-top: 8px;
}

.subjudul-ramping {
  font-size: 15px;
  font-weight: 500;
  color: white;
  margin-top: -12px; /* ‚¨ÖÔ∏è lebih rapat lagi */
  line-height: 1.2;   /* ‚¨ÖÔ∏è padatkan jarak antar baris */
  text-align: center;
}

.transaksi-box {
  position: relative;
  background: linear-gradient(to left, #2e7d32, #a5d6a7);
  padding: 32px;
  box-shadow:
    0 8px 16px rgba(0,0,0,0.25),   /* bayangan bawah dalam */
    0 0 0 2px rgba(255,255,255,0.1), /* garis tepi terang */
    inset 0 1px 2px rgba(255,255,255,0.2); /* efek cahaya dalam */
  width: 100%;
  max-width: 960px;
  margin: auto;
  color: white;
  border-radius: 16px;
  transition: box-shadow 0.3s ease;
}

.judul-transaksi {
  font-size: 32px;
  font-weight: bold;
  margin-top: 4px;         /* ‚¨ÖÔ∏è jarak atas dipersempit */
  margin-bottom: 20px;
  text-align: center;
  color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  letter-spacing: 1px;
}

.btn-tutup {
  position: absolute;
  top: 16px;
  right: 16px;
  background-color: transparent;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: white;
}
    .btn-tutup:hover {
      background-color: #c82333;
    }

    .box-no-id,
    .box-form-horizontal,
    .box-form-horizontal.kedua {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 14px;
      color: #333;
      display: block;
    }

    .form-group input {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    .btn-simpan {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
    }

.btn-simpan:focus {
  background-color: #ff5722;
  outline: none;
  box-shadow: none;
}
    .btn-simpan:hover {
      background-color: #ff5722;
    }


.pengajuan {
  background-color: #009688; /* Warna dasar: teal */
  color: white;
  height: 20px;
  line-height: 20px;
  padding: 0 24px;
  border: none;
  border-radius: 6px;
  text-decoration: none;
  font-weight: bold;
  font-size: 12px;
  display: inline-block;
  text-align: center;
  transition: background-color 0.3s ease;
}

.pengajuan:hover {
  background-color: #00796b;
}

.pengajuan:focus {
  background-color: #00796b;
  outline: none;
  box-shadow: none;
}
    .gambar-area {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
    }

    .gambar-penuh {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }

    .aksi-horizontal {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

.btn-aksi {
  padding: 10px 16px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  min-width: 140px;
  transition: background-color 0.2s ease, box-shadow 0.2s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15); /* ‚¨ÖÔ∏è bayangan awal */
}

/* Tombol Edit */
.btn-aksi.edit {
  background-color: #28a745;
  color: white;
}
.btn-aksi.edit:hover {
  background-color: #218838; /* ‚¨ÖÔ∏è versi lebih gelap */
  box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* ‚¨ÖÔ∏è efek 3D saat hover */
}

/* Tombol Input Saldo */
.btn-aksi.input-saldo {
  background-color: #ffc107;
  color: #333;
}
.btn-aksi.input-saldo:hover {
  background-color: #e0a800;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* Tombol Cetak Kartu */
.btn-aksi.cetak-kartu {
  background-color: #17a2b8;
  color: white;
}
.btn-aksi.cetak-kartu:hover {
  background-color: #138496;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.grid-3-kolom {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 24px;
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
}

.kolom {
  background-color: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.foto-box {
  width: 100%;
  max-width: 160px;
  height: 160px;
  margin: 0 auto 16px;
  border: 2px dashed #aaa;
  border-radius: 8px;
  background-color: #fefefe;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.foto-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.table-wrapper {
  width: 100%;
  max-height: 400px;
  overflow-x: auto;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-top: 10px;
  margin-bottom: 24px;
}

#tabel-transaksi {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  table-layout: fixed; /* ‚¨ÖÔ∏è kunci agar kolom tidak langsung melebar */
}

#tabel-transaksi th,
#tabel-transaksi td {
  padding: 6px 10px;
  border-bottom: 1px solid #ddd;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#tabel-transaksi thead {
  position: sticky;
  top: 0;
  background-color: #e8f5e9;
  z-index: 1;
}

#tabel-transaksi tbody tr:nth-child(even) {
  background-color: #f9f9f9;
}

#tabel-transaksi tbody tr:hover {
  background-color: #e6f7ff;
}


#jumlah-kiriman {
  font-size: 18px;              /* ‚¨ÖÔ∏è lebih besar */
  font-weight: 600;             /* ‚¨ÖÔ∏è agak tebal */
  color: #ffc107;               /* ‚¨ÖÔ∏è kuning terang */
  background-color: #fffde7;    /* ‚¨ÖÔ∏è latar kuning pudar */
  border: 2px solid #ffc107;
}

#saldo-terbaru {
  font-size: 18px;
  font-weight: 600;
  color: #28a745;               /* ‚¨ÖÔ∏è hijau terang */
  background-color: #e8f5e9;    /* ‚¨ÖÔ∏è latar hijau pudar */
  border: 2px solid #28a745;
}

.btn-status-mini {
  background-color: #8BC34A;     /* hijau daun cerah */
  color: #FFEB3B;                /* teks kuning terang */
  border: none;                  /* tanpa garis tepi */
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: bold;
  cursor: default;
  width: 120px;
  height: 36px;
  text-align: center;
  box-shadow: none;              /* tanpa bayangan */
  outline: none;                 /* tanpa garis fokus */
}

  </style>
</head>
<body>

<div class="judul-container">
  <div class="judul-flex">
    <img src="https://brnqpdvtninzyqqwhmfj.supabase.co/storage/v1/object/public/fotoku12/LAMBANG.jpg" alt="Logo Kepang" class="logo-kepang">
    <div>
      <h3 class="judul-box">KAUNTRI</h3>
      <div class="subjudul-ramping">Kartu Keuangan Santri</div>
    </div>
  </div>
</div>

<div style="text-align:center;">
    <button id="btn-mulai" class="btn-mulai">üü¢ MULAI TRANSAKSI</button>
  </div>

  <!-- üî∑ Box Gambar Tetap Tampil -->
  <div class="box-no-id kedua gambar-saja">
    <div class="gambar-area">
      <img src="https://tse4.mm.bing.net/th/id/OIP.Byp3baV39njGXGW04hOyNQHaE4?pid=Api&P=0&h=180" alt="Icon Transaksi" class="gambar-penuh">
    </div>
    <div class="aksi-horizontal">
      <button class="btn-aksi edit" onclick="window.location.href='https://skretaris1919-cloud.github.io/KAUNTRI/TRANSAKSIMASSAL.HTML'">üí∏ Transaksi massal</button>
      <button class="btn-aksi input-saldo" onclick="window.location.href='https://skretaris1919-cloud.github.io/KAUNTRI/INPUT SALDO.HTML'">üí∞ Input Saldo</button>
      <button class="btn-aksi cetak-kartu" onclick="window.location.href='https://skretaris1919-cloud.github.io/KAUNTRI/KARTU.HTML'">üìÑ Cetak Kartu</button>
    </div>
  </div>

<!-- üî∂ Overlay Transaksi -->
<div id="transaksi-overlay" class="overlay-transaksi">
  <div class="transaksi-box">
    <button class="btn-tutup" onclick="document.getElementById('transaksi-overlay').style.display='none'">‚ùå Tutup</button>
    <h3 id="judul-transaksi" class="judul-transaksi">TRANSAKSI SANTRI</h3>
    <div class="grid-3-kolom">
      <!-- Kolom 1: Form Transaksi + Foto -->
      <div class="kolom">
        <div class="foto-box">
          <img id="preview-foto" src="" alt="Foto Santri">
        </div>

        <div class="form-group"><label for="no-id">No ID Santri</label><input type="text" id="no-id"></div>
        <div class="form-group"><label for="nama">Nama</label><input type="text" id="nama"></div>
        <div class="form-group"><label for="nominal">Nominal</label><input type="text" id="nominal"></div>
        <div class="form-group"><button id="btn-simpan" class="btn-simpan">TRANSAKSI</button></div>
       <div class="form-group">
  <a href="https://skretaris1919-cloud.github.io/KAUNTRI/PENGAJUAN.html" class="pengajuan">PENGAJUAN</a>
</div>>
        </div>

      <!-- Kolom 2: Rincian 1 -->
      <div class="kolom">
        <div class="form-group"><label for="kamar">Nama Kamar</label><input type="text" id="kamar"></div>
        <div class="form-group"><label for="alamat">Alamat</label><input type="text" id="alamat"></div>
        <div class="form-group"><label for="jumlah">Saldo Kiriman</label><input type="text" id="jumlah"></div>
        <div class="form-group"><label for="saldo-awal">Saldo Tabungan</label><input type="text" id="saldo-awal"></div>
        <div class="form-group"><label for="saldo-akhir">Saldo Akhir</label><input type="text" id="saldo-akhir" readonly></div>
        <div class="form-group">
  <label for="catatan">Catatan</label>
  <textarea id="catatan" class="auto-expand"></textarea>
</div>
      </div>

      <!-- Kolom 3: Rincian 2 -->
      <div class="kolom">
        <div class="form-group"><label for="limit-harian">Limit Harian</label><input type="text" id="limit-harian"></div>
        <div class="form-group"><label for="total-hari-ini">Total Hari Ini</label><input type="text" id="total-hari-ini"></div>
        <div class="form-group"><label for="makan">Makan</label><input type="text" id="makan"></div>
        <div class="form-group"><label for="jumlah-kiriman">Sisa Kiriman</label><input type="text" id="jumlah-kiriman" readonly></div>
        <div class="form-group"><label for="saldo-terbaru">Saldo Terbaru</label><input type="text" id="saldo-terbaru" readonly></div>
       <div class="form-group">
  <label for="pengajuan">Pengajuan</label>
  <textarea id="pengajuan" class="auto-expand"></textarea>
<div class="form-group">
  <button id="status-pengajuan" class="btn-status-abu">‚ùå Belum Disetujui</button>
</div>
</div>
      </div>
    </div>
  </div>
</div>
  
<link rel="icon" href="favicon.ico" type="image/x-icon">

  
<div class="table-wrapper">
  <table id="tabel-transaksi">
    <thead>
      <tr>
        <th style="width: 120px;">No ID</th>
        <th style="width: 160px;">Nama</th>
        <th style="width: 120px;">Kamar</th>
        <th style="width: 180px;">Alamat</th>
        <th style="width: 100px;">Jumlah</th>
        <th style="width: 100px;">Nominal</th>
        <th style="width: 100px;">Saldo Awal</th>
        <th style="width: 100px;">Saldo Akhir</th>
        <th style="width: 100px;">Limit Harian</th>
        <th style="width: 100px;">Makan</th>
        <th style="width: 120px;">Jumlah Kiriman</th>
        <th style="width: 120px;">Saldo Terbaru</th>
        <th style="width: 160px;">Waktu</th>
        <th style="width: 200px;">Catatan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
</div>
  <link rel="icon" href="data:,">
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  'https://brnqpdvtninzyqqwhmfj.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybnFwZHZ0bmluenlxcXdobWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjU3OTQsImV4cCI6MjA3MzE0MTc5NH0.6u2P5ANnDV1237hEY73M0OHRDftwc3-G0JbRx44YcZc'
);

// üî¢ Format visual Rp
function formatRupiah(angka) {
  if (angka === '' || angka === null || angka === undefined) return '';
  const num = parseFloat(angka.toString().replace(/[^\d\-]/g, ''));
  if (isNaN(num)) return '';
  const isNegative = num < 0;
  const formatted = Math.abs(num).toLocaleString('id-ID');
  return (isNegative ? '-Rp ' : 'Rp ') + formatted;
}

function unformatRupiah(rpString) {
  return parseFloat(rpString.replace(/[^\d]/g, '')) || 0;
}

// üîÅ Kalkulasi otomatis
function updateKalkulasi() {
  const nominal = unformatRupiah(document.getElementById('nominal').value);
  const jumlah = unformatRupiah(document.getElementById('jumlah').value);
  const saldoAwal = unformatRupiah(document.getElementById('saldo-awal').value);

  const kiriman = jumlah - nominal;
  const saldoTerbaru = saldoAwal + kiriman;

  const jumlahKirimanInput = document.getElementById('jumlah-kiriman');
  const saldoTerbaruInput = document.getElementById('saldo-terbaru');

  if (kiriman < 0) {
    alert('Saldo kiriman Anda tidak mencukupi, silakan isi ulang.');
    document.getElementById('nominal').value = '';
    jumlahKirimanInput.value = '';
    saldoTerbaruInput.value = '';
    jumlahKirimanInput.classList.remove('negatif');
    document.getElementById('nominal').focus();
    return;
  }

  jumlahKirimanInput.value = formatRupiah(kiriman);
  saldoTerbaruInput.value = formatRupiah(saldoTerbaru);
  jumlahKirimanInput.classList.toggle('negatif', kiriman < 0);
}

// üîÅ Hitung total transaksi hari ini
async function hitungTotalHariIni(noId) {
  const awalHari = new Date(); awalHari.setHours(0, 0, 0, 0);
  const akhirHari = new Date(); akhirHari.setHours(23, 59, 59, 999);

  const { data, error } = await supabase
    .from('tb_transaksi')
    .select('nominal')
    .eq('no_id', noId)
    .gte('waktu', awalHari.toISOString())
    .lte('waktu', akhirHari.toISOString());

  if (error) return console.error('Gagal hitung total hari ini:', error.message);

  const total = data.reduce((sum, row) => {
    const nilai = typeof row.nominal === 'string'
      ? parseFloat(row.nominal.replace(/[^\d]/g, '')) || 0
      : row.nominal || 0;
    return sum + nilai;
  }, 0);

  document.getElementById('total-hari-ini').value = formatRupiah(total);
}

// üîÅ Load tabel transaksi
async function loadTransaksiTable() {
  const { data, error } = await supabase
    .from('tb_transaksi')
    .select('no_id, nama, nama_kamar, alamat, jumlah, nominal, saldo_tabungan, saldo_akhir, limit_harian, makan, jumlah_kiriman, waktu, catatan')
    .order('waktu', { ascending: false })
    .limit(1000);

  if (error) return console.error('Gagal ambil data:', error.message);

  const tbody = document.querySelector('#tabel-transaksi tbody');
  if (!tbody) return;

  tbody.innerHTML = '';
  data.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.no_id ?? '-'}</td>
      <td>${row.nama ?? '-'}</td>
      <td>${row.nama_kamar ?? '-'}</td>
      <td>${row.alamat ?? '-'}</td>
      <td>${formatRupiah(row.jumlah)}</td>
      <td>${formatRupiah(row.nominal)}</td>
      <td>${formatRupiah(row.saldo_tabungan)}</td>
      <td>${formatRupiah(row.saldo_akhir)}</td>
      <td>${formatRupiah(row.limit_harian)}</td>
      <td>${formatRupiah(row.makan)}</td>
      <td>${formatRupiah(row.jumlah_kiriman)}</td>
      <td>${formatRupiah(unformatRupiah(row.saldo_tabungan) + unformatRupiah(row.jumlah_kiriman))}</td>
      <td>${new Date(row.waktu).toLocaleString('id-ID')}</td>
      <td>${row.catatan ?? '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

// üîÅ Simpan transaksi
async function simpanTransaksi() {
  const btnSimpan = document.getElementById('btn-simpan');
  btnSimpan.disabled = true;

  const data = {
    no_id: document.getElementById('no-id').value.trim(),
    nama: document.getElementById('nama').value.trim(),
    nama_kamar: document.getElementById('kamar').value.trim(),
    alamat: document.getElementById('alamat').value.trim(),
    jumlah: unformatRupiah(document.getElementById('jumlah').value.trim()),
    saldo_tabungan: unformatRupiah(document.getElementById('saldo-awal').value.trim()),
    saldo_akhir: unformatRupiah(document.getElementById('saldo-akhir').value.trim()),
    limit_harian: unformatRupiah(document.getElementById('limit-harian').value.trim()),
    makan: document.getElementById('makan').value.trim(),
    jumlah_kiriman: unformatRupiah(document.getElementById('jumlah-kiriman').value.trim()),
    saldo_terbaru: unformatRupiah(document.getElementById('saldo-terbaru').value.trim()),
    nominal: unformatRupiah(document.getElementById('nominal').value.trim()),
    catatan: document.getElementById('catatan').value.trim(),
    waktu: new Date().toISOString(),
    created_by: 'system'
  };

  if (!data.no_id || !data.nominal) {
    alert('No ID dan Nominal wajib diisi.');
    btnSimpan.disabled = false;
    return;
  }

  const { error: insertError } = await supabase.from('tb_transaksi').insert([data]);
  if (insertError) {
    console.error('Gagal simpan:', insertError.message);
    alert('Gagal menyimpan data.');
    btnSimpan.disabled = false;
    return;
  }

  alert('Data berhasil disimpan ke tb_transaksi.');

  // üîç Ambil data saldo lama
  const { data: saldoData, error: saldoError } = await supabase
    .from('tb_saldo')
    .select('jumlah_kiriman, saldo_akhir, saldo_tabungan, pengajuan, nilai_ajuan, sts_pengajuan')
    .eq('no_id', data.no_id)
    .order('waktu', { ascending: false })
    .limit(1);

  if (saldoError || !saldoData || saldoData.length === 0) {
    console.warn('Tidak ditemukan data tb_saldo untuk update:', data.no_id);
  } else {
    const saldoLama = saldoData[0];
    const updatePayload = {};

    if (saldoLama.jumlah_kiriman !== data.jumlah_kiriman) {
      updatePayload.jumlah_kiriman = data.jumlah_kiriman;
    }
    if (saldoLama.saldo_akhir !== data.saldo_terbaru) {
      updatePayload.saldo_akhir = data.saldo_terbaru;
    }
    if (saldoLama.saldo_tabungan !== data.saldo_tabungan) {
      updatePayload.saldo_tabungan = data.saldo_tabungan;
    }

    const pengajuanBaru = document.getElementById('pengajuan')?.value.trim() || '';
    if ((saldoLama.pengajuan || '') !== pengajuanBaru) {
      updatePayload.pengajuan = pengajuanBaru;
    }

    const nilaiPengajuan = parseInt(saldoLama.nilai_ajuan || "0");
    const nominalTransaksi = parseInt(data.nominal || "0");
    const keperluan = saldoLama.pengajuan || "-";

    if (nominalTransaksi >= nilaiPengajuan && nilaiPengajuan > 0 && keperluan !== "-") {
      const konfirmasi = confirm(
        `‚ö†Ô∏è Nilai pengajuan anda senilai Rp ${nilaiPengajuan.toLocaleString("id-ID")} untuk keperluan "${keperluan}".\n` +
        `Apakah anda yakin transaksi ini akan menghapus catatan pengajuan tersebut?`
      );

      if (konfirmasi) {
        updatePayload.pengajuan = "";
        updatePayload.nilai_ajuan = "";
        updatePayload.sts_pengajuan = "";
      } else {
        console.log("‚ùå Penghapusan pengajuan dibatalkan oleh pengguna.");
      }
    }

    if (Object.keys(updatePayload).length > 0) {
      const { error: updateError } = await supabase
        .from('tb_saldo')
        .update(updatePayload)
        .eq('no_id', data.no_id);

      if (updateError) {
        console.error('Gagal update tb_saldo:', updateError.message);
      } else {
        console.log('tb_saldo berhasil diupdate:', updatePayload);
      }
    } else {
      console.log('Tidak ada perubahan pada tb_saldo, skip update.');
    }
  }

  // üîÅ Reset semua input
  document.querySelectorAll('input').forEach(input => input.value = '');
  document.getElementById('no-id').focus();
  updateKalkulasi();
  loadTransaksiTable();

  const judulTransaksi = document.getElementById('judul-transaksi');
  if (judulTransaksi) judulTransaksi.textContent = 'TRANSAKSI SANTRI';

  btnSimpan.disabled = false;
}


// üîÅ Update saldo
async function updateSaldo(data) {
  const { data: saldoData, error: saldoError } = await supabase
    .from('tb_saldo')
    .select('jumlah_kiriman, saldo_akhir, saldo_tabungan, pengajuan, nilai_ajuan, sts_pengajuan')
    .eq('no_id', data.no_id)
    .order('waktu', { ascending: false })
    .limit(1);

  if (saldoError || !saldoData || saldoData.length === 0) return;

  const saldoLama = saldoData[0];
  const updatePayload = {};

  if (saldoLama.jumlah_kiriman !== data.jumlah_kiriman) updatePayload.jumlah_kiriman = data.jumlah_kiriman;
  if (saldoLama.saldo_akhir !== data.saldo_terbaru) updatePayload.saldo_akhir = data.saldo_terbaru;
  if (saldoLama.saldo_tabungan !== data.saldo_tabungan) updatePayload.saldo_tabungan = data.saldo_tabungan;

    const pengajuanBaru = document.getElementById('pengajuan')?.value.trim() || '';
  if ((saldoLama.pengajuan || '') !== pengajuanBaru) {
    updatePayload.pengajuan = pengajuanBaru;
  }

  const nilaiPengajuan = parseInt(saldoLama.nilai_ajuan || "0");
  const nominalTransaksi = parseInt(data.nominal || "0");
  const keperluan = saldoLama.pengajuan || "-";

  if (nominalTransaksi >= nilaiPengajuan && nilaiPengajuan > 0 && keperluan !== "-") {
    const konfirmasi = confirm(
      `‚ö†Ô∏è Nilai pengajuan anda senilai Rp ${nilaiPengajuan.toLocaleString("id-ID")} untuk keperluan "${keperluan}".\n` +
      `Apakah anda yakin transaksi ini akan menghapus catatan pengajuan tersebut?`
    );

    if (konfirmasi) {
      updatePayload.pengajuan = "";
      updatePayload.nilai_ajuan = "";
      updatePayload.sts_pengajuan = "";
    } else {
      console.log("‚ùå Penghapusan pengajuan dibatalkan oleh pengguna.");
    }
  }

  if (Object.keys(updatePayload).length > 0) {
    const { error: updateError } = await supabase
      .from('tb_saldo')
      .update(updatePayload)
      .eq('no_id', data.no_id);

    if (updateError) {
      console.error('Gagal update tb_saldo:', updateError.message);
    } else {
      console.log('tb_saldo berhasil diupdate:', updatePayload);
    }
  } else {
    console.log('Tidak ada perubahan pada tb_saldo, skip update.');
  }
}

// üîÅ Reset form
function resetForm() {
  document.querySelectorAll('input').forEach(input => input.value = '');
  document.getElementById('no-id').focus();
  document.getElementById('judul-transaksi').textContent = 'TRANSAKSI SANTRI';
  updateKalkulasi();
}

// üîÅ Inisialisasi saat halaman siap
document.addEventListener('DOMContentLoaded', () => {
  loadTransaksiTable();

  // üîÅ Format semua input nominal
  const nominalFields = [
    'nominal', 'jumlah', 'saldo-awal', 'saldo-akhir',
    'limit-harian', 'total-hari-ini', 'makan',
    'jumlah-kiriman', 'saldo-terbaru'
  ];

  nominalFields.forEach(id => {
    const input = document.getElementById(id);
    if (!input) return;
    input.addEventListener('input', () => {
      const raw = unformatRupiah(input.value);
      input.value = formatRupiah(raw);
      if (id === 'nominal') updateKalkulasi();
    });
  });

  // üîÅ Tombol mulai transaksi
  document.getElementById('btn-mulai').addEventListener('click', function () {
    document.getElementById('transaksi-overlay').style.display = 'flex';
    setTimeout(() => {
      const inputID = document.getElementById('no-id');
      if (inputID) {
        inputID.focus();
        inputID.select();
      }
    }, 100);
  });

  // üîÅ Enter di input nominal langsung fokus ke tombol simpan
  document.getElementById('nominal').addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('btn-simpan').focus();
    }
  });

  // üîÅ Input ID santri ‚Üí load data
  const noIdInput = document.getElementById('no-id');
  const fotoPreview = document.getElementById('preview-foto');
  const judulTransaksi = document.getElementById('judul-transaksi');

  noIdInput.addEventListener('input', async () => {
    const noId = noIdInput.value.trim();
    if (!noId || noId.length < 3) {
      if (judulTransaksi) judulTransaksi.textContent = 'TRANSAKSI SANTRI';
      return;
    }

    const fields = ['nama', 'kamar', 'alamat', 'jumlah', 'saldo-awal', 'saldo-akhir', 'limit-harian', 'makan', 'jumlah-kiriman', 'saldo-terbaru', 'total-hari-ini'];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    if (fotoPreview) fotoPreview.src = '';

    const { data, error } = await supabase
      .from('tb_saldo')
      .select('*')
      .eq('no_id', noId)
      .order('waktu', { ascending: false })
      .limit(1);

    if (error || !data || data.length === 0) return;

    const d = data[0];
    if (judulTransaksi && d.nama) judulTransaksi.textContent = d.nama.toUpperCase();

    document.getElementById('nama').value = d.nama || '';
    document.getElementById('kamar').value = d.nama_kamar || '';
    document.getElementById('alamat').value = d.alamat || '';
    document.getElementById('jumlah').value = formatRupiah(d.jumlah_kiriman || 0);
    document.getElementById('saldo-awal').value = formatRupiah(d.saldo_tabungan || 0);
    updateKalkulasi();
    document.getElementById('saldo-akhir').value = formatRupiah(d.saldo_akhir || 0);
    document.getElementById('limit-harian').value = formatRupiah(d.limit_harian || 0);
    document.getElementById('makan').value = formatRupiah(d.makan || 0);
    document.getElementById('jumlah-kiriman').value = '';
    const kiriman = unformatRupiah(d.jumlah_kiriman || '0');
    const saldoAwal = unformatRupiah(d.saldo_tabungan || '0');
    document.getElementById('saldo-terbaru').value = formatRupiah(saldoAwal + kiriman);
    if (d.foto_url && fotoPreview) fotoPreview.src = d.foto_url;
    document.getElementById('nominal').focus();
    document.getElementById('pengajuan').value = d.pengajuan || '';
    document.getElementById('catatan').value = d.catatan || '';

    const pengajuanText = (d.pengajuan || '').trim().toLowerCase();
    const statusText = (d.sts_pengajuan || '').trim().toLowerCase();
    const statusBtn = document.getElementById('status-pengajuan');

    if (statusBtn) {
      if (!pengajuanText) {
        statusBtn.textContent = '';
        statusBtn.style.backgroundColor = '#ccc';
        statusBtn.style.color = '#333';
      } else if (statusText === 'setuju') {
        statusBtn.textContent = 'Setuju';
        statusBtn.style.backgroundColor = '#c8e6c9';
        statusBtn.style.color = '#2e7d32';
      } else {
        statusBtn.style.backgroundColor = '#ffcdd2';
        statusBtn.style.color = '#c62828';
      }
    }

    updateKalkulasi();
    await hitungTotalHariIni(noId);
  });

  // üîÅ Pasang listener simpan hanya sekali
  if (!window.simpanListenerTerpasang) {
    document.getElementById('btn-simpan').addEventListener('click', simpanTransaksi);
    window.simpanListenerTerpasang = true;
  }
});

</script>
</body>
</html>


