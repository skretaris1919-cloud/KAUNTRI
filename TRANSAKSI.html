<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Form Kasir Santri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 0;
    }

    .judul-box {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 16px;
      text-align: center;
      color: #333;
      margin-bottom: 4px;
    }

.form-group input:focus {
  outline: none;
  background-color: #e3f2fd;         
  color: #0d6efd;                   
  font-weight: bold;                
  border: 2px solid #0d6efd;       
  box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3); 
  transition: all 0.2s ease;
}

textarea:focus,
select:focus {
  background-color: #e3f2fd;
  color: #0d6efd;
  font-weight: bold;
  border: 2px solid #0d6efd;
  box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.3);
  transition: all 0.2s ease;
}

.judul-container {
  position: fixed; /* ⬅️ Tetap di posisi atas layar */
  top: 0;           /* ⬅️ Menempel di bagian atas */
  left: 0;
  right: 0;
  z-index: 999;     /* ⬅️ Pastikan tampil di atas elemen lain */
  
  background: linear-gradient(to right, #1b5e20, #004d40);
  padding: 4px 0;   /* ⬅️ Padding atas saja */
  margin: 0 auto;
  width: 100%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  color: white;
  text-align: center;
  border-radius: 0;
}

.judul-flex {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px; /* ⬅️ jarak antara logo dan teks */
}

.logo-kepang {
  width: 48px;
  height: 48px;
  object-fit: contain;
  margin-right: -4px;
  align-self: flex-end; /* ⬅️ sejajarkan ke bawah baris */
}

    .btn-mulai {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-bottom: 24px;
      margin-top: 120px;
    }
    .btn-mulai:hover {
      background-color: #218838;
    }

    .overlay-transaksi {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backdrop-filter: blur(6px);
      background-color: rgba(0, 0, 0, 0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

.subjudul-wrapper {
  text-align: center; /* ⬅️ pastikan kontennya rata tengah */
  margin-top: 8px;
}

.subjudul-ramping {
  font-size: 15px;
  font-weight: 500;
  color: white;
  margin-top: -12px; /* ⬅️ lebih rapat lagi */
  line-height: 1.2;   /* ⬅️ padatkan jarak antar baris */
  text-align: center;
}
.judul-flex {
  display: flex;
  align-items: center;     /* ⬅️ Vertikal center */
  gap: 12px;               /* ⬅️ Jarak antara logo dan teks */
  padding: 8px 16px;       /* ⬅️ Ruang dalam */
}

.logo-kepang {
  height: 40px;            /* ⬅️ Ukuran logo agar tidak terlalu besar */
  width: auto;
}

.judul-box {
  margin: 0;
  font-size: 20px;
  line-height: 1.2;
}

.subjudul-ramping {
  font-size: 14px;
  margin-top: 2px;
}
.transaksi-box {
  position: relative;
  background: linear-gradient(to left, #2e7d32, #a5d6a7);
  padding: 32px;
  box-shadow:
    0 8px 16px rgba(0,0,0,0.25),   /* bayangan bawah dalam */
    0 0 0 2px rgba(255,255,255,0.1), /* garis tepi terang */
    inset 0 1px 2px rgba(255,255,255,0.2); /* efek cahaya dalam */
  width: 100%;
  max-width: 960px;
  margin: auto;
  color: white;
  border-radius: 16px;
  transition: box-shadow 0.3s ease;
}

.judul-transaksi {
  font-size: 32px;
  font-weight: bold;
  margin-top: 4px;         /* ⬅️ jarak atas dipersempit */
  margin-bottom: 20px;
  text-align: center;
  color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  letter-spacing: 1px;
}

.btn-tutup {
  position: absolute;
  top: 16px;
  right: 16px;
  background-color: transparent;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: white;
}
    .btn-tutup:hover {
      background-color: #c82333;
    }

    .box-no-id,
    .box-form-horizontal,
    .box-form-horizontal.kedua {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 14px;
      color: #333;
      display: block;
    }

    .form-group input {
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    .btn-simpan {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
    }

.btn-simpan:focus {
  background-color: #ff5722;
  outline: none;
  box-shadow: none;
}
    .btn-simpan:hover {
      background-color: #ff5722;
    }


.pengajuan {
  background-color: #009688; /* Warna dasar: teal */
  color: white;
  height: 20px;
  line-height: 20px;
  padding: 0 24px;
  border: none;
  border-radius: 6px;
  text-decoration: none;
  font-weight: bold;
  font-size: 12px;
  display: inline-block;
  text-align: center;
  transition: background-color 0.3s ease;
}

.pengajuan:hover {
  background-color: #00796b;
}

.pengajuan:focus {
  background-color: #00796b;
  outline: none;
  box-shadow: none;
}


.gambar-area {
  display: flex;
  justify-content: center;
}

.box-info-kiri {
  display: flex;
  gap: 6px; /* antar kolom makin rapat */
  flex-wrap: nowrap; /* ⬅️ paksa sejajar horizontal */
  background-color: #ffffff;
  padding: 6px;
  border-radius: 6px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  width: 100%;
  max-width: 360px; /* ⬅️ total box makin kecil */
  box-sizing: border-box;
}

.kolom-info {
  flex: 1;
  min-width: 120px;
}

.kolom-info label {
  display: block;
  font-weight: bold;
  margin-bottom: 1px;
  font-size: 12px;
  color: #2e7d32;
}

.kolom-info input {
  width: 80px; /* ⬅️ lebar input makin kecil */
  padding: 4px 6px;
  margin-bottom: 4px;
  border: 1px solid #ccc;
  border-radius: 3px;
  font-size: 12px;
  background-color: #f9f9f9;
}

    .gambar-penuh {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
    }

    .aksi-horizontal {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }


/* Tombol Umum */
.btn-aksi {
  display: block;
  width: 100%; /* ⬅️ tombol penuh lebar panel */
  padding: 10px 16px;
  font-size: 16px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.2s ease, box-shadow 0.2s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

/* Tombol Edit */
.btn-aksi.edit {
  background-color: #28a745;
  color: white;
}
.btn-aksi.edit:hover {
  background-color: #218838;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* Tombol Input Saldo */
.btn-aksi.input-saldo {
  background-color: #ffc107;
  color: #333;
}
.btn-aksi.input-saldo:hover {
  background-color: #e0a800;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* Tombol Cetak Kartu */
.btn-aksi.cetak-kartu {
  background-color: #17a2b8;
  color: white;
}
.btn-aksi.cetak-kartu:hover {
  background-color: #138496;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}


.grid-3-kolom {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 24px;
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
}

.kolom {
  background-color: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.foto-box {
  width: 100%;
  max-width: 160px;
  height: 160px;
  margin: 0 auto 16px;
  border: 2px dashed #aaa;
  border-radius: 8px;
  background-color: #fefefe;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.foto-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.table-wrapper {
  width: 100%;
  max-height: 400px;
  overflow-x: auto;
  border: 1px solid #ccc;
  border-radius: 8px;
  margin-top: 10px;
  margin-bottom: 24px;
}

#tabel-transaksi {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  table-layout: fixed; /* ⬅️ kunci agar kolom tidak langsung melebar */
}

#tabel-transaksi th,
#tabel-transaksi td {
  padding: 6px 10px;
  border-bottom: 1px solid #ddd;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#tabel-transaksi thead {
  position: sticky;
  top: 0;
  background-color: #e8f5e9;
  z-index: 1;
}

#tabel-transaksi tbody tr:nth-child(even) {
  background-color: #f9f9f9;
}

#tabel-transaksi tbody tr:hover {
  background-color: #e6f7ff;
}


#jumlah-kiriman {
  font-size: 18px;              /* ⬅️ lebih besar */
  font-weight: 600;             /* ⬅️ agak tebal */
  color: #ffc107;               /* ⬅️ kuning terang */
  background-color: #fffde7;    /* ⬅️ latar kuning pudar */
  border: 2px solid #ffc107;
}

#saldo-terbaru {
  font-size: 18px;
  font-weight: 600;
  color: #28a745;               /* ⬅️ hijau terang */
  background-color: #e8f5e9;    /* ⬅️ latar hijau pudar */
  border: 2px solid #28a745;
}

.btn-status-mini {
  background-color: #8BC34A;     /* hijau daun cerah */
  color: #FFEB3B;                /* teks kuning terang */
  border: none;                  /* tanpa garis tepi */
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: bold;
  cursor: default;
  width: 120px;
  height: 36px;
  text-align: center;
  box-shadow: none;              /* tanpa bayangan */
  outline: none;                 /* tanpa garis fokus */
}

.panel-filter {
  position: fixed;
  top: 80px;
  right: 0;
  height: auto;
  width: 80px;
  background: #f0f0f0;
  border-radius: 8px 0 0 8px;
  box-shadow: -2px 0 6px rgba(0,0,0,0.1);
  transition: width 0.3s ease;
  overflow: hidden;
  z-index: 999;
}

.panel-filter.terbuka {
  width: 240px;
}

.panel-header {
  background: #1976d2;
  color: white;
  padding: 10px;
  font-weight: bold;
  cursor: pointer;
  text-align: center;
  border-radius: 8px 0 0 0;
}

.panel-body {
  padding: 12px;
  font-size: 13px;
  display: none;
}

.panel-filter.terbuka .panel-body {
  display: block;
}

.panel-aksi {
  position: fixed;
  top: 80px;
  left: 0;
  height: auto;
  width: 80px;
  background: #90ee90;
  border-radius: 0 8px 8px 0;
  box-shadow: 2px 0 6px rgba(0,0,0,0.1);
  transition: width 0.3s ease;
  overflow: hidden;
  z-index: 999;
}

.panel-aksi.terbuka {
  width: 240px;
}

.panel-aksi .panel-header {
  background: #ffff00;
  color: black;
  padding: 10px;
  font-weight: bold;
  cursor: pointer;
  text-align: center;
  border-radius: 0 8px 0 0;
}

.panel-aksi .panel-body {
  padding: 12px;
  font-size: 13px;
  display: none;
}

.panel-aksi.terbuka .panel-body {
  display: block;
}


  </style>
</head>
<body>

<div class="judul-container">
  <div class="judul-flex">
    <img src="https://brnqpdvtninzyqqwhmfj.supabase.co/storage/v1/object/public/fotoku12/LAMBANG.jpg" alt="Logo Kepang" class="logo-kepang">
    <div>
      <h3 class="judul-box">KAUNTRI</h3>
      <div class="subjudul-ramping">Kartu Keuangan Santri</div>
    </div>
  </div>
</div>

<div style="text-align:center;">
    <button id="btn-mulai" class="btn-mulai">🟢 MULAI TRANSAKSI</button>
  </div>

<div class="box-no-id kedua gambar-saja" style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-start;">
  
<<div class="gambar-area">
  <div class="box-info-kiri">
    <!-- 🔹 Kiri: Info Tabungan -->
    <div class="kolom-info">
      <label>Ttl Tabungan</label>
      <input type="text" id="ttl-tabungan" readonly>
      <label>Ttl Kiriman</label>
      <input type="text" id="ttl-kiriman" readonly>
      <label>Ttl Saldo Akhir</label>
      <input type="text" id="ttl-saldo-akhir" readonly>
    </div>

    <!-- 🔸 Kanan: Info Pengeluaran -->
    <div class="kolom-info">
      <label>Keluar Hari Ini</label>
      <input type="text" id="keluar-hari" readonly>
      <label>Keluar 1 Pekan</label>
      <input type="text" id="keluar-pekan" readonly>
      <label>Keluar 1 Bulan</label>
      <input type="text" id="keluar-bulan" readonly>
    </div>
  </div>
</div>

<!-- 🔸 Tengah: Gambar -->
<div class="gambar-wrapper">
  <img src="https://tse4.mm.bing.net/th/id/OIP.Byp3baV39njGXGW04hOyNQHaE4?pid=Api&P=0&h=180" alt="Icon Transaksi" class="gambar-penuh">
</div>

<div class="box-samping kanan" style="display: grid; grid-template-columns: 1fr 126px 160px; gap: 12px; align-items: start;">
  <!-- Grafik Garis -->
  <div>
    <h4>Grafik Transaksi Tahun Ini</h4>
    <canvas id="grafik-transaksi" width="240" height="140"></canvas>
  </div>

  <!-- Grafik Lingkaran -->
  <div>
    <h4>Komposisi Saldo Akhir</h4>
    <canvas id="grafik-komposisi" width="126" height="126"></canvas>
  </div>

  <!-- Box Perbandingan -->
<div class="box-perbandingan" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
  <h4>Perbandingan Pengeluaran Terakhir</h4>
  <p id="info-perbandingan" style="font-size: 16px; font-weight: bold; color: #2e7d32;"></p>
</div>
</div>

 <!-- 🔳 Panel Filter Minimalis -->
<div id="panel-filter" class="panel-filter tertutup"
     onmouseenter="bukaPanelFilter()" 
     onmouseleave="tutupPanelFilter()">
  <div class="panel-header">🧮 Filter</div>
  <div class="panel-body">
    <div class="form-group">
      <label for="filter-id">ID Santri</label>
      <input type="text" id="filter-id">
    </div>
    <div class="form-group">
      <label for="tanggal-awal">Mulai</label>
      <input type="date" id="tanggal-awal">
    </div>
    <div class="form-group">
      <label for="tanggal-akhir">Sampai</label>
      <input type="date" id="tanggal-akhir">
    </div>
    <div class="aksi-horizontal" style="margin-top: 10px;">
      <button class="btn-aksi cetak-kartu" onclick="filterTransaksi()">🔎 Filter</button>
      <button class="btn-aksi input-saldo" onclick="loadTransaksiTable()">🔄 Reset</button>
    </div>
  </div>
</div>

<!-- 🔳 Panel Aksi Kiri -->
<div id="panel-aksi" class="panel-aksi tertutup"
     onmouseenter="bukaPanelAksi()" 
     onmouseleave="tutupPanelAksi()">
  <div class="panel-header">⚙️ Aksi</div>
  <div class="panel-body">
    <button class="btn-aksi edit" onclick="window.location.href='https://skretaris1919-cloud.github.io/KAUNTRI/TRANSAKSIMASSAL.HTML'">💸 Transaksi massal</button>
    <button class="btn-aksi input-saldo" onclick="window.location.href='https://skretaris1919-cloud.github.io/KAUNTRI/INPUT SALDO.HTML'">💰 Input Saldo</button>
    <button class="btn-aksi cetak-kartu" onclick="window.location.href='https://skretaris1919-cloud.github.io/KAUNTRI/KARTU.HTML'">📄 Cetak Kartu</button>
  </div>
</div>

<!-- 🔶 Overlay Transaksi -->
<div id="transaksi-overlay" class="overlay-transaksi">
  <div class="transaksi-box">
    <button class="btn-tutup" onclick="document.getElementById('transaksi-overlay').style.display='none'">❌ Tutup</button>
    <h3 id="judul-transaksi" class="judul-transaksi">TRANSAKSI SANTRI</h3>
    <div class="grid-3-kolom">
      <!-- Kolom 1: Form Transaksi + Foto -->
      <div class="kolom">
        <div class="foto-box">
          <img id="preview-foto" src="" alt="Foto Santri">
        </div>

        <div class="form-group"><label for="no-id">No ID Santri</label><input type="text" id="no-id"></div>
        <div class="form-group"><label for="nama">Nama</label><input type="text" id="nama"></div>
        <div class="form-group"><label for="nominal">Nominal</label><input type="text" id="nominal"></div>
        <div class="form-group"><button id="btn-simpan" class="btn-simpan">TRANSAKSI</button></div>
       <div class="form-group">
  <a href="https://skretaris1919-cloud.github.io/KAUNTRI/PENGAJUAN.html" class="pengajuan">PENGAJUAN</a>
</div>>
        </div>

      <!-- Kolom 2: Rincian 1 -->
      <div class="kolom">
        <div class="form-group"><label for="kamar">Nama Kamar</label><input type="text" id="kamar"></div>
        <div class="form-group"><label for="alamat">Alamat</label><input type="text" id="alamat"></div>
        <div class="form-group"><label for="jumlah">Saldo Kiriman</label><input type="text" id="jumlah"></div>
        <div class="form-group"><label for="saldo-awal">Saldo Tabungan</label><input type="text" id="saldo-awal"></div>
        <div class="form-group"><label for="saldo-akhir">Saldo Akhir</label><input type="text" id="saldo-akhir" readonly></div>
        <div class="form-group">
  <label for="catatan">Catatan</label>
  <textarea id="catatan" class="auto-expand">Harian</textarea>
</div>
      </div>

      <!-- Kolom 3: Rincian 2 -->
      <div class="kolom">
        <div class="form-group"><label for="limit-harian">Limit Harian</label><input type="text" id="limit-harian"></div>
        <div class="form-group"><label for="total-hari-ini">Total Hari Ini</label><input type="text" id="total-hari-ini"></div>
        <div class="form-group"><label for="makan">Makan</label><input type="text" id="makan"></div>
        <div class="form-group"><label for="jumlah-kiriman">Sisa Kiriman</label><input type="text" id="jumlah-kiriman" readonly></div>
        <div class="form-group"><label for="saldo-terbaru">Saldo Terbaru</label><input type="text" id="saldo-terbaru" readonly></div>
       <div class="form-group">
  <label for="pengajuan">Pengajuan</label>
  <textarea id="pengajuan" class="auto-expand"></textarea>
<div class="form-group">
  <button id="status-pengajuan" class="btn-status-abu">❌ Belum Disetujui</button>
</div>
</div>
      </div>
    </div>
  </div>
</div>
  
<link rel="icon" href="favicon.ico" type="image/x-icon">

  
<div class="table-wrapper">
  <table id="tabel-transaksi">
    <thead>
      <tr>
        <th style="width: 120px;">No ID</th>
        <th style="width: 160px;">Nama</th>
        <th style="width: 120px;">Kamar</th>
        <th style="width: 180px;">Alamat</th>
        <th style="width: 100px;">Jumlah Kiriman</th>
        <th style="width: 100px;">Pengeluaran</th>
        <th style="width: 100px;">Saldo Tabungan</th>
        <th style="width: 100px;">Saldo Akhir</th>
        <th style="width: 100px;">Limit Harian</th>
        <th style="width: 100px;">Makan</th>
        <th style="width: 120px;">Jumlah Kiriman</th>
        <th style="width: 120px;">Saldo Terbaru</th>
        <th style="width: 160px;">Waktu</th>
        <th style="width: 200px;">Catatan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
</div>
  <link rel="icon" href="data:,">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>


<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// 🔐 Supabase credentials
const supabase = createClient(
  'https://brnqpdvtninzyqqwhmfj.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJybnFwZHZ0bmluenlxcXdobWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1NjU3OTQsImV4cCI6MjA3MzE0MTc5NH0.6u2P5ANnDV1237hEY73M0OHRDftwc3-G0JbRx44YcZc'
);


async function renderGrafikTransaksi() {
  // 🔁 Ambil nominal dari tb_transaksi
  const { data: transaksiData, error: transaksiError } = await supabase
    .from('tb_transaksi')
    .select('nominal, waktu')
    .gte('waktu', '2025-01-01T00:00:00')
    .lte('waktu', '2025-12-31T23:59:59')
    .limit(1000);

  // 🔁 Ambil jumlah kiriman dari tb_insaldo
  const { data: insaldoData, error: insaldoError } = await supabase
    .from('tb_insaldo')
    .select('jumlah_kiriman, created_at')
    .gte('created_at', '2025-01-01T00:00:00')
    .lte('created_at', '2025-12-31T23:59:59')
    .limit(1000);

  if (transaksiError || insaldoError || !transaksiData || !insaldoData) {
    console.error("Gagal ambil data grafik:", transaksiError || insaldoError);
    return;
  }

  // 🔄 Kelompokkan nominal per bulan dari tb_transaksi
  const nominalPerBulan = {};
  for (const row of transaksiData) {
    const bulan = new Date(row.waktu).getMonth() + 1;
    if (!nominalPerBulan[bulan]) nominalPerBulan[bulan] = 0;
    nominalPerBulan[bulan] += Number(row.nominal || 0);
  }

  // 🔄 Kelompokkan jumlah kiriman per bulan dari tb_insaldo
  const kirimanPerBulan = {};
  for (const row of insaldoData) {
    const bulan = new Date(row.created_at).getMonth() + 1;
    if (!kirimanPerBulan[bulan]) kirimanPerBulan[bulan] = 0;
    kirimanPerBulan[bulan] += Number(row.jumlah_kiriman || 0);
  }

  const labels = Array.from({ length: 12 }, (_, i) => `Bulan ${i + 1}`);
  const nominalData = labels.map((_, i) => nominalPerBulan[i + 1] || 0);
  const kirimanData = labels.map((_, i) => kirimanPerBulan[i + 1] || 0);

  // 🔁 Grafik Garis
  const canvas = document.getElementById('grafik-transaksi');
  if (!canvas) {
    console.error("Canvas #grafik-transaksi tidak ditemukan.");
    return;
  }

  const ctx = canvas.getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Nominal Transaksi (Rp)',
          data: nominalData,
          borderColor: '#2e7d32',
          backgroundColor: 'transparent',
          tension: 0.3
        },
        {
          label: 'Jumlah Kiriman (tb_insaldo)',
          data: kirimanData,
          borderColor: '#0288d1',
          backgroundColor: 'transparent',
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: false,
      plugins: {
        legend: { position: 'bottom' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // 🔁 Grafik Lingkaran Komposisi Saldo Akhir
  const totalSaldo = Object.values(nominalPerBulan).reduce((a, b) => a + b, 0);
  const totalKiriman = Object.values(kirimanPerBulan).reduce((a, b) => a + b, 0);
  const totalAkhir = totalSaldo + totalKiriman;

  const canvasPie = document.getElementById('grafik-komposisi');
  if (!canvasPie) {
    console.error("Canvas #grafik-komposisi tidak ditemukan.");
    return;
  }

  const ctxPie = canvasPie.getContext('2d');
  new Chart(ctxPie, {
    type: 'pie',
    data: {
      labels: ['Saldo Tabungan', 'Jumlah Kiriman'],
      datasets: [{
        data: [totalSaldo, totalKiriman],
        backgroundColor: ['#4caf50', '#03a9f4'],
        borderWidth: 1
      }]
    },
    options: {
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.raw;
              const percent = ((value / totalAkhir) * 100).toFixed(1);
              return `${context.label}: Rp${value.toLocaleString()} (${percent}%)`;
            }
          }
        },
        datalabels: {
          color: '#fff',
          font: {
            weight: 'bold',
            size: 14
          },
          formatter: function(value) {
            const percent = ((value / totalAkhir) * 100).toFixed(1);
            return `${percent}%`;
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });

  // 🔁 Box Perbandingan Dua Bulan Terakhir
  const bulanNama = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];

  const bulanAda = Object.keys(nominalPerBulan)
    .map(b => parseInt(b))
    .filter(b => nominalPerBulan[b] > 0)
    .sort((a, b) => b - a); // urut mundur

  if (bulanAda.length >= 2) {
    const b1 = bulanAda[0]; // bulan terbaru
    const b2 = bulanAda[1]; // bulan sebelumnya

    const total1 = nominalPerBulan[b1] || 0;
    const total2 = nominalPerBulan[b2] || 0;
    const selisih = total1 - total2;
    const arah = selisih > 0 ? '📈' : selisih < 0 ? '📉' : '➡️';

    const info = `
      ${bulanNama[b2 - 1]}: Rp${total2.toLocaleString()}<br>
      ${bulanNama[b1 - 1]}: Rp${total1.toLocaleString()}<br>
      Perubahan: ${arah} Rp${Math.abs(selisih).toLocaleString()}
    `;

    const infoBox = document.getElementById('info-perbandingan');
    if (infoBox) infoBox.innerHTML = info;
  }
}



window.bukaPanelAksi = function () {
  const panel = document.getElementById('panel-aksi');
  panel.classList.add('terbuka');
  panel.classList.remove('tertutup');
};

window.tutupPanelAksi = function () {
  const panel = document.getElementById('panel-aksi');
  panel.classList.remove('terbuka');
  panel.classList.add('tertutup');
};


window.bukaPanelFilter = function () {
  const panel = document.getElementById('panel-filter');
  panel.classList.add('terbuka');
  panel.classList.remove('tertutup');
};

window.tutupPanelFilter = function () {
  const panel = document.getElementById('panel-filter');
  panel.classList.remove('terbuka');
  panel.classList.add('tertutup');
};



window.filterTransaksi = async function () {
  const id = document.getElementById('filter-id')?.value.trim();
  const mulai = document.getElementById('tanggal-awal')?.value;
  const sampai = document.getElementById('tanggal-akhir')?.value;

  if (!mulai || !sampai) {
    alert('Tanggal mulai dan sampai wajib diisi.');
    return;
  }

  const mulaiISO = new Date(mulai).toISOString();
  const sampaiISO = new Date(sampai + 'T23:59:59').toISOString();

  const { data, error } = await supabase
    .from('tb_transaksi')
    .select('no_id, nama, nama_kamar, alamat, jumlah, nominal, saldo_tabungan, saldo_akhir, limit_harian, makan, jumlah_kiriman, waktu, catatan')
    .gte('waktu', mulaiISO)
    .lte('waktu', sampaiISO)
    .order('waktu', { ascending: false });

  if (error) {
    console.error('Gagal filter:', error.message);
    alert('Gagal mengambil data filter.');
    return;
  }

  const tbody = document.querySelector('#tabel-transaksi tbody');
  tbody.innerHTML = '';

  data.forEach(row => {
    // Cocokkan ID jika diisi (case-insensitive, parsial)
    if (id && !(String(row.no_id || '').toLowerCase().includes(id.toLowerCase()))) return;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.no_id ?? '-'}</td>
      <td>${row.nama ?? '-'}</td>
      <td>${row.nama_kamar ?? '-'}</td>
      <td>${row.alamat ?? '-'}</td>
      <td>${formatRupiah(row.jumlah)}</td>
      <td>${formatRupiah(row.nominal)}</td>
      <td>${formatRupiah(row.saldo_tabungan)}</td>
      <td>${formatRupiah(row.saldo_akhir)}</td>
      <td>${formatRupiah(row.limit_harian)}</td>
      <td>${formatRupiah(row.makan)}</td>
      <td>${formatRupiah(row.jumlah_kiriman)}</td>
      <td>${formatRupiah(unformatRupiah(row.saldo_tabungan) + unformatRupiah(row.jumlah_kiriman))}</td>
      <td>${new Date(row.waktu).toLocaleString('id-ID')}</td>
      <td>${row.catatan ?? '-'}</td>
    `;
    tbody.appendChild(tr);
  });

  if (tbody.children.length === 0) {
    alert('Tidak ditemukan transaksi yang cocok dengan filter.');
  }
};

async function isiBoxKiriGlobal() {
  try {
    // 🔹 Ambil data saldo dari tb_saldo
    const { data: dataSaldo, error: errorSaldo } = await supabase
      .from('tb_saldo')
      .select('saldo_tabungan, jumlah_kiriman, saldo_akhir')
      .order('waktu', { ascending: false })
      .limit(1000);

    if (errorSaldo) {
      console.error('Gagal ambil data saldo:', errorSaldo.message);
      return;
    }

    const totalTabungan = dataSaldo.reduce((sum, row) => sum + Number(row.saldo_tabungan || 0), 0);
    const totalKiriman = dataSaldo.reduce((sum, row) => sum + Number(row.jumlah_kiriman || 0), 0);
    const totalSaldoAkhir = dataSaldo.reduce((sum, row) => sum + Number(row.saldo_akhir || 0), 0);

    document.getElementById('ttl-tabungan').value = formatRupiah(totalTabungan);
    document.getElementById('ttl-kiriman').value = formatRupiah(totalKiriman);
    document.getElementById('ttl-saldo-akhir').value = formatRupiah(totalSaldoAkhir);

    // 🔸 Ambil data transaksi dari tb_transaksi
    const { data: dataTransaksi, error: errorTransaksi } = await supabase
      .from('tb_transaksi')
      .select('nominal, waktu')
      .order('waktu', { ascending: false })
      .limit(1000);

    if (errorTransaksi) {
      console.error('Gagal ambil data transaksi:', errorTransaksi.message);
      return;
    }

    const now = new Date();
    const awalHari = new Date(); awalHari.setHours(0, 0, 0, 0);
    const awalPekan = new Date(now); awalPekan.setDate(now.getDate() - 7);
    const awalBulan = new Date(now); awalBulan.setDate(now.getDate() - 30);

    const totalKeluar = (start) => dataTransaksi
      .filter(t => new Date(t.waktu) >= start)
      .reduce((sum, t) => sum + Number(unformatRupiah(t.nominal || '0')), 0);

    document.getElementById('keluar-hari').value = formatRupiah(totalKeluar(awalHari));
    document.getElementById('keluar-pekan').value = formatRupiah(totalKeluar(awalPekan));
    document.getElementById('keluar-bulan').value = formatRupiah(totalKeluar(awalBulan));
  } catch (err) {
    console.error('❌ Error isiBoxKiriGlobal:', err.message);
  }
}

// 🔢 Format visual Rp
function formatRupiah(angka) {
  if (angka === '' || angka === null || angka === undefined) return '';
  const num = parseFloat(angka.toString().replace(/[^\d\-]/g, ''));
  if (isNaN(num)) return '';
  const isNegative = num < 0;
  const formatted = Math.abs(num).toLocaleString('id-ID');
  return (isNegative ? '-Rp ' : 'Rp ') + formatted;
}

function unformatRupiah(rpString) {
  return parseFloat(rpString.replace(/[^\d]/g, '')) || 0;
}

// 🔁 Kalkulasi otomatis
function updateKalkulasi() {
  const nominal = unformatRupiah(document.getElementById('nominal').value);
  const jumlah = unformatRupiah(document.getElementById('jumlah').value);
  const saldoAwal = unformatRupiah(document.getElementById('saldo-awal').value);

  const kiriman = jumlah - nominal;
  const saldoTerbaru = saldoAwal + kiriman;

  const jumlahKirimanInput = document.getElementById('jumlah-kiriman');
  const saldoTerbaruInput = document.getElementById('saldo-terbaru');

  if (kiriman < 0) {
    alert('Saldo kiriman Anda tidak mencukupi, silakan isi ulang.');
    document.getElementById('nominal').value = '';
    jumlahKirimanInput.value = '';
    saldoTerbaruInput.value = '';
    jumlahKirimanInput.classList.remove('negatif');
    document.getElementById('nominal').focus();
    return;
  }

  jumlahKirimanInput.value = formatRupiah(kiriman);
  saldoTerbaruInput.value = formatRupiah(saldoTerbaru);
  jumlahKirimanInput.classList.toggle('negatif', kiriman < 0);
}

// 🔁 Hitung total transaksi hari ini
async function hitungTotalHariIni(noId) {
  const awalHari = new Date(); awalHari.setHours(0, 0, 0, 0);
  const akhirHari = new Date(); akhirHari.setHours(23, 59, 59, 999);

  const { data, error } = await supabase
    .from('tb_transaksi')
    .select('nominal')
    .eq('no_id', noId)
    .gte('waktu', awalHari.toISOString())
    .lte('waktu', akhirHari.toISOString());

  if (error) return console.error('Gagal hitung total hari ini:', error.message);

  const total = data.reduce((sum, row) => {
    const nilai = typeof row.nominal === 'string'
      ? parseFloat(row.nominal.replace(/[^\d]/g, '')) || 0
      : row.nominal || 0;
    return sum + nilai;
  }, 0);

  document.getElementById('total-hari-ini').value = formatRupiah(total);
}

// 🔁 Load tabel transaksi
async function loadTransaksiTable() {
  const { data, error } = await supabase
    .from('tb_transaksi')
    .select('no_id, nama, nama_kamar, alamat, jumlah, nominal, saldo_tabungan, saldo_akhir, limit_harian, makan, jumlah_kiriman, waktu, catatan')
    .order('waktu', { ascending: false })
    .limit(1000);

  if (error) return console.error('Gagal ambil data:', error.message);

  const tbody = document.querySelector('#tabel-transaksi tbody');
  if (!tbody) return;

  tbody.innerHTML = '';
  data.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.no_id ?? '-'}</td>
      <td>${row.nama ?? '-'}</td>
      <td>${row.nama_kamar ?? '-'}</td>
      <td>${row.alamat ?? '-'}</td>
      <td>${formatRupiah(row.jumlah)}</td>
      <td>${formatRupiah(row.nominal)}</td>
      <td>${formatRupiah(row.saldo_tabungan)}</td>
      <td>${formatRupiah(row.saldo_akhir)}</td>
      <td>${formatRupiah(row.limit_harian)}</td>
      <td>${formatRupiah(row.makan)}</td>
      <td>${formatRupiah(row.jumlah_kiriman)}</td>
      <td>${formatRupiah(unformatRupiah(row.saldo_tabungan) + unformatRupiah(row.jumlah_kiriman))}</td>
      <td>${new Date(row.waktu).toLocaleString('id-ID')}</td>
      <td>${row.catatan ?? '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

window.loadTransaksiTable = loadTransaksiTable;

// 🔁 Simpan transaksi
async function simpanTransaksi() {
  const btnSimpan = document.getElementById('btn-simpan');
  btnSimpan.disabled = true;

  const data = {
    no_id: document.getElementById('no-id').value.trim(),
    nama: document.getElementById('nama').value.trim(),
    nama_kamar: document.getElementById('kamar').value.trim(),
    alamat: document.getElementById('alamat').value.trim(),
    jumlah: unformatRupiah(document.getElementById('jumlah').value.trim()),
    saldo_tabungan: unformatRupiah(document.getElementById('saldo-awal').value.trim()),
    saldo_akhir: unformatRupiah(document.getElementById('saldo-akhir').value.trim()),
    limit_harian: unformatRupiah(document.getElementById('limit-harian').value.trim()),
    makan: document.getElementById('makan').value.trim(),
    jumlah_kiriman: unformatRupiah(document.getElementById('jumlah-kiriman').value.trim()),
    saldo_terbaru: unformatRupiah(document.getElementById('saldo-terbaru').value.trim()),
    nominal: unformatRupiah(document.getElementById('nominal').value.trim()),
    catatan: document.getElementById('catatan').value.trim(),
    waktu: new Date().toISOString(),
    created_by: 'system'
  };

  if (!data.no_id || !data.nominal) {
    alert('No ID dan Nominal wajib diisi.');
    btnSimpan.disabled = false;
    return;
  }

  const { error: insertError } = await supabase.from('tb_transaksi').insert([data]);
  if (insertError) {
    console.error('Gagal simpan:', insertError.message);
    alert('Gagal menyimpan data.');
    btnSimpan.disabled = false;
    return;
  }

  alert('Data berhasil disimpan ke tb_transaksi.');

  // 🔍 Ambil data saldo lama
  const { data: saldoData, error: saldoError } = await supabase
    .from('tb_saldo')
    .select('jumlah_kiriman, saldo_akhir, saldo_tabungan, pengajuan, nilai_ajuan, sts_pengajuan')
    .eq('no_id', data.no_id)
    .order('waktu', { ascending: false })
    .limit(1);

  if (saldoError || !saldoData || saldoData.length === 0) {
    console.warn('Tidak ditemukan data tb_saldo untuk update:', data.no_id);
  } else {
    const saldoLama = saldoData[0];
    const updatePayload = {};

    if (saldoLama.jumlah_kiriman !== data.jumlah_kiriman) {
      updatePayload.jumlah_kiriman = data.jumlah_kiriman;
    }
    if (saldoLama.saldo_akhir !== data.saldo_terbaru) {
      updatePayload.saldo_akhir = data.saldo_terbaru;
    }
    if (saldoLama.saldo_tabungan !== data.saldo_tabungan) {
      updatePayload.saldo_tabungan = data.saldo_tabungan;
    }

    const pengajuanBaru = document.getElementById('pengajuan')?.value.trim() || '';
    if ((saldoLama.pengajuan || '') !== pengajuanBaru) {
      updatePayload.pengajuan = pengajuanBaru;
    }

    const nilaiPengajuan = parseInt(saldoLama.nilai_ajuan || "0");
    const nominalTransaksi = parseInt(data.nominal || "0");
    const keperluan = saldoLama.pengajuan || "-";

    if (nominalTransaksi >= nilaiPengajuan && nilaiPengajuan > 0 && keperluan !== "-") {
      const konfirmasi = confirm(
        `⚠️ Nilai pengajuan anda senilai Rp ${nilaiPengajuan.toLocaleString("id-ID")} untuk keperluan "${keperluan}".\n` +
        `Apakah anda yakin transaksi ini akan menghapus catatan pengajuan tersebut?`
      );

      if (konfirmasi) {
        updatePayload.pengajuan = "";
        updatePayload.nilai_ajuan = "";
        updatePayload.sts_pengajuan = "";
      } else {
        console.log("❌ Penghapusan pengajuan dibatalkan oleh pengguna.");
      }
    }

    if (Object.keys(updatePayload).length > 0) {
      const { error: updateError } = await supabase
        .from('tb_saldo')
        .update(updatePayload)
        .eq('no_id', data.no_id);

      if (updateError) {
        console.error('Gagal update tb_saldo:', updateError.message);
      } else {
        console.log('tb_saldo berhasil diupdate:', updatePayload);
      }
    } else {
      console.log('Tidak ada perubahan pada tb_saldo, skip update.');
    }
  }

  // 🔁 Reset semua input
  document.querySelectorAll('input').forEach(input => input.value = '');
  document.getElementById('no-id').focus();
  updateKalkulasi();
  loadTransaksiTable();
  isiBoxKiriGlobal();
  renderGrafikTransaksi();

  const judulTransaksi = document.getElementById('judul-transaksi');
  if (judulTransaksi) judulTransaksi.textContent = 'TRANSAKSI SANTRI';

  btnSimpan.disabled = false;
}


// 🔁 Update saldo
async function updateSaldo(data) {
  const { data: saldoData, error: saldoError } = await supabase
    .from('tb_saldo')
    .select('jumlah_kiriman, saldo_akhir, saldo_tabungan, pengajuan, nilai_ajuan, sts_pengajuan')
    .eq('no_id', data.no_id)
    .order('waktu', { ascending: false })
    .limit(1);

  if (saldoError || !saldoData || saldoData.length === 0) return;

  const saldoLama = saldoData[0];
  const updatePayload = {};

  if (saldoLama.jumlah_kiriman !== data.jumlah_kiriman) updatePayload.jumlah_kiriman = data.jumlah_kiriman;
  if (saldoLama.saldo_akhir !== data.saldo_terbaru) updatePayload.saldo_akhir = data.saldo_terbaru;
  if (saldoLama.saldo_tabungan !== data.saldo_tabungan) updatePayload.saldo_tabungan = data.saldo_tabungan;

    const pengajuanBaru = document.getElementById('pengajuan')?.value.trim() || '';
  if ((saldoLama.pengajuan || '') !== pengajuanBaru) {
    updatePayload.pengajuan = pengajuanBaru;
  }

  const nilaiPengajuan = parseInt(saldoLama.nilai_ajuan || "0");
  const nominalTransaksi = parseInt(data.nominal || "0");
  const keperluan = saldoLama.pengajuan || "-";

  if (nominalTransaksi >= nilaiPengajuan && nilaiPengajuan > 0 && keperluan !== "-") {
    const konfirmasi = confirm(
      `⚠️ Nilai pengajuan anda senilai Rp ${nilaiPengajuan.toLocaleString("id-ID")} untuk keperluan "${keperluan}".\n` +
      `Apakah anda yakin transaksi ini akan menghapus catatan pengajuan tersebut?`
    );

    if (konfirmasi) {
      updatePayload.pengajuan = "";
      updatePayload.nilai_ajuan = "";
      updatePayload.sts_pengajuan = "";
    } else {
      console.log("❌ Penghapusan pengajuan dibatalkan oleh pengguna.");
    }
  }

  if (Object.keys(updatePayload).length > 0) {
    const { error: updateError } = await supabase
      .from('tb_saldo')
      .update(updatePayload)
      .eq('no_id', data.no_id);

    if (updateError) {
      console.error('Gagal update tb_saldo:', updateError.message);
    } else {
      console.log('tb_saldo berhasil diupdate:', updatePayload);
    }
  } else {
    console.log('Tidak ada perubahan pada tb_saldo, skip update.');
  }
}

// 🔁 Reset form
function resetForm() {
  document.querySelectorAll('input').forEach(input => input.value = '');
  document.getElementById('no-id').focus();
  document.getElementById('judul-transaksi').textContent = 'TRANSAKSI SANTRI';
  updateKalkulasi();
}

// 🔁 Inisialisasi saat halaman siap
document.addEventListener('DOMContentLoaded', async () => {
  loadTransaksiTable();
  await isiBoxKiriGlobal();
  await renderGrafikTransaksi();
});


  // 🔁 Format semua input nominal
  const nominalFields = [
    'nominal', 'jumlah', 'saldo-awal', 'saldo-akhir',
    'limit-harian', 'total-hari-ini', 'makan',
    'jumlah-kiriman', 'saldo-terbaru'
  ];

  nominalFields.forEach(id => {
    const input = document.getElementById(id);
    if (!input) return;
    input.addEventListener('input', () => {
      const raw = unformatRupiah(input.value);
      input.value = formatRupiah(raw);
      if (id === 'nominal') updateKalkulasi();
    });
  });

  // 🔁 Tombol mulai transaksi
  document.getElementById('btn-mulai').addEventListener('click', function () {
    document.getElementById('transaksi-overlay').style.display = 'flex';
    setTimeout(() => {
      const inputID = document.getElementById('no-id');
      if (inputID) {
        inputID.focus();
        inputID.select();
      }
    }, 100);
  });

  // 🔁 Enter di input nominal langsung fokus ke tombol simpan
  document.getElementById('nominal').addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('btn-simpan').focus();
    }
  });

  // 🔁 Input ID santri → load data
  const noIdInput = document.getElementById('no-id');
  const fotoPreview = document.getElementById('preview-foto');
  const judulTransaksi = document.getElementById('judul-transaksi');

  noIdInput.addEventListener('input', async () => {
    const noId = noIdInput.value.trim();
    if (!noId || noId.length < 3) {
      if (judulTransaksi) judulTransaksi.textContent = 'TRANSAKSI SANTRI';
      return;
    }

    const fields = ['nama', 'kamar', 'alamat', 'jumlah', 'saldo-awal', 'saldo-akhir', 'limit-harian', 'makan', 'jumlah-kiriman', 'saldo-terbaru', 'total-hari-ini'];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    if (fotoPreview) fotoPreview.src = '';

    const { data, error } = await supabase
      .from('tb_saldo')
      .select('*')
      .eq('no_id', noId)
      .order('waktu', { ascending: false })
      .limit(1);

    if (error || !data || data.length === 0) return;

    const d = data[0];
    if (judulTransaksi && d.nama) judulTransaksi.textContent = d.nama.toUpperCase();

    document.getElementById('nama').value = d.nama || '';
    document.getElementById('kamar').value = d.nama_kamar || '';
    document.getElementById('alamat').value = d.alamat || '';
    document.getElementById('jumlah').value = formatRupiah(d.jumlah_kiriman || 0);
    document.getElementById('saldo-awal').value = formatRupiah(d.saldo_tabungan || 0);
    updateKalkulasi();
    document.getElementById('saldo-akhir').value = formatRupiah(d.saldo_akhir || 0);
    document.getElementById('limit-harian').value = formatRupiah(d.limit_harian || 0);
    document.getElementById('makan').value = formatRupiah(d.makan || 0);
    document.getElementById('jumlah-kiriman').value = '';
    const kiriman = unformatRupiah(d.jumlah_kiriman || '0');
    const saldoAwal = unformatRupiah(d.saldo_tabungan || '0');
    document.getElementById('saldo-terbaru').value = formatRupiah(saldoAwal + kiriman);
    if (d.foto_url && fotoPreview) fotoPreview.src = d.foto_url;
    document.getElementById('nominal').focus();
    document.getElementById('pengajuan').value = d.pengajuan || '';
    document.getElementById('catatan').value = d.catatan || 'Harian';

    const pengajuanText = (d.pengajuan || '').trim().toLowerCase();
    const statusText = (d.sts_pengajuan || '').trim().toLowerCase();
    const statusBtn = document.getElementById('status-pengajuan');

    if (statusBtn) {
      if (!pengajuanText) {
        statusBtn.textContent = '';
        statusBtn.style.backgroundColor = '#ccc';
        statusBtn.style.color = '#333';
      } else if (statusText === 'setuju') {
        statusBtn.textContent = 'Setuju';
        statusBtn.style.backgroundColor = '#c8e6c9';
        statusBtn.style.color = '#2e7d32';
      } else {
        statusBtn.style.backgroundColor = '#ffcdd2';
        statusBtn.style.color = '#c62828';
      }
    }

    updateKalkulasi();
    await hitungTotalHariIni(noId);
  });

  document.addEventListener('DOMContentLoaded', async () => {
    if (!window.simpanListenerTerpasang) {
      document.getElementById('btn-simpan').addEventListener('click', simpanTransaksi);
      window.simpanListenerTerpasang = true;
    }

    await isiBoxKiriGlobal();
  });

</script>
</body>
</html>


